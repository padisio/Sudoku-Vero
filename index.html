<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>VeruchiDoku</title>
  <meta name="theme-color" content="#0ea5e9">
  <style>
    :root{
      --bg:#fafafa; --panel:#ffffff; --panelSO:#f3f4f6; --accent:#0ea5e9;
      --text:#111827; --muted:#6b7280; --error:#dc2626; --ok:#059669;
      --cell:#ffffff; --given:#eef7ff;
      --thin:#dce5ef;             /* lÃ­neas internas finas */
      --bold:#1e40af;             /* separadores 3x3 */
      --rc-fill:rgba(56,189,248,.18); --same-fill:rgba(59,130,246,.18);
      --shadow:0 8px 22px rgba(0,0,0,.08), inset 0 0 0 1px rgba(0,0,0,.05);
    }
    .dark{
      --bg:#0b1220; --panel:#0f172a; --panelSO:#0a1426; --accent:#0ea5e9;
      --text:#e5e7eb; --muted:#94a3b8; --error:#ef4444; --ok:#10b981;
      --cell:#0e1a31; --given:#0f213c;
      --thin:#0f2745; --bold:#38bdf8;
      --rc-fill:rgba(14,61,120,.28); --same-fill:rgba(11,31,62,.7);
      --shadow:0 10px 40px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.04);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;
      color:var(--text); background:var(--bg); display:flex;flex-direction:column;gap:12px}
    header,footer{padding:12px 16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0;font-weight:800;letter-spacing:.2px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select,button{appearance:none;border:none;outline:none;background:var(--panel);color:var(--text);
      padding:10px 12px;border-radius:12px;font-weight:700;letter-spacing:.2px; box-shadow:var(--shadow)}
    button:active{transform:scale(.98)} button.primary{background:var(--accent);color:#001421}
    button.warn{background:#f59e0b;color:#1b1300} button.good{background:#059669;color:#00120e}
    .iconbtn{width:44px;height:44px;display:flex;align-items:center;justify-content:center;font-size:18px}
    .container{padding:0 12px 18px;display:grid;gap:12px}
    .grid-wrap{display:flex;justify-content:center}
    .grid{
      display:grid;grid-template-columns:repeat(9,1fr);
      gap:0; /* IMPORTANT: no gap; borders draw the grid */
      padding:6px;border-radius:14px;background:var(--panelSO);box-shadow:var(--shadow);
      width:min(94vw,540px);aspect-ratio:1/1;position:relative;overflow:hidden;
    }
    .cell{
      position:relative;background:var(--cell);
      display:flex;align-items:center;justify-content:center;
      font-weight:800;font-size:min(6vw,28px);
      border-radius:0; color:var(--text);
      user-select:none; -webkit-user-select:none; touch-action:manipulation;
      transition:background .12s, outline-color .12s, color .12s, box-shadow .12s;
      /* thin grid using top/left borders only */
      border-top:1px solid var(--thin);
      border-left:1px solid var(--thin);
      z-index:1;
    }
    /* outer border */
    .grid .cell.edge-top{border-top-color:transparent}
    .grid .cell.edge-left{border-left-color:transparent}
    .grid .cell.edge-right{border-right:1px solid var(--thin)}
    .grid .cell.edge-bottom{border-bottom:1px solid var(--thin)}
    /* strong 3x3 separators exactly after rows 3 & 6, cols 3 & 6 */
    .grid .cell.sepR{border-right:3px solid var(--bold)}
    .grid .cell.sepB{border-bottom:3px solid var(--bold)}
    .cell.given{background:var(--given)}
    .cell.sel{outline:3px solid var(--accent);z-index:2}
    .cell.rc{box-shadow:inset 0 0 0 9999px var(--rc-fill)}
    .cell.same{box-shadow:inset 0 0 0 9999px var(--same-fill)}
    .cell.conflict{outline:3px solid var(--error)}
    .cell.wrong{color:var(--error); text-shadow:0 0 8px rgba(239,68,68,.35)}
    .cell .notes{position:absolute;inset:0;padding:6px;display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);
      color:var(--muted);font-weight:700;font-size:min(3.2vw,14px);opacity:.95}
    .pad{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    .pad button{height:52px;border-radius:12px;font-size:17px}
    .stats{display:flex;gap:10px;align-items:center;justify-content:space-between;background:var(--panel);padding:10px 12px;border-radius:14px;box-shadow:var(--shadow)}
    .mini{font-size:12px;color:var(--muted)} .counter{display:grid;grid-template-columns:repeat(9,1fr);gap:6px}
    .counter div{background:var(--panelSO);padding:6px;border-radius:10px;text-align:center;font-size:12px;box-shadow:var(--shadow)}
    footer{opacity:.7;font-size:12px;text-align:center}
    /* Win overlay */
    .win{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:10}
    .win .card{background:var(--panel);border-radius:18px;padding:24px;min-width:260px;text-align:center;box-shadow:var(--shadow)}
    .win h2{margin:0 0 6px 0;font-size:24px}
    .confetti{position:absolute;inset:0;overflow:hidden;pointer-events:none}
  </style>
<style>

/* ===== ULTRA COMPACT / NO-OVERFLOW (v13) ===== */
html, body { max-width: 100%; overflow-x: hidden; }
header, .container, footer { width: 100%; margin: 0 auto; padding-left: max(8px, env(safe-area-inset-left)); padding-right: max(8px, env(safe-area-inset-right)); }
.grid-wrap { width: 100%; overflow: hidden; }
.grid { width: 100% !important; max-width: 100% !important; margin: 0 auto; }
.pad, .counter { width: 100%; }
.pad { display: grid; grid-template-columns: repeat(5, minmax(0,1fr)) !important; gap: 8px; }
.counter { display: grid; grid-template-columns: repeat(9, minmax(0,1fr)) !important; gap: 6px; }
.pad button { width: 100%; min-width: 0; height: 44px; }
select, button { max-width: 100%; min-width: 0; }
.stats { flex-wrap: wrap; gap: 10px; }
.row { flex-wrap: wrap; }
/* Tipos algo mÃ¡s pequeÃ±os para evitar cortes */
.cell { font-size: clamp(13px, 3.8vw, 21px) !important; }
.cell .notes { font-size: clamp(9px, 2.4vw, 12px) !important; }
/* Afinamos separadores y bordes */
.grid .cell.sepR { border-right-width: 2px !important; }
.grid .cell.sepB { border-bottom-width: 2px !important; }
/* Reducimos padding del grid para ganar unos px */
.grid { padding: 4px !important; }
/* PequeÃ±os ajustes en pantallas muy estrechas */
@media (max-width: 380px){
  .pad button { height: 40px; font-size: 15px; }
  .iconbtn{ width: 36px; height: 36px; }
  header, footer { padding-left: 8px; padding-right: 8px; }
}

</style>
<style>

/* === FONT SIZE ADJUSTMENT (v14) === */
.cell { font-size: clamp(15px, 4.5vw, 26px) !important; }
.cell .notes { font-size: clamp(10px, 2.8vw, 14px) !important; }

</style>

  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0ea5e9">
</head>
<body>
  <header>
    <h1>VeruchiDoku</h1>
    <div class="row">
      <select id="difficulty">
        <option value="easy">FÃ¡cil</option>
        <option value="medium" selected>Media</option>
        <option value="hard">DifÃ­cil</option>
        <option value="expert">Experto</option>
      </select>
      <button id="new" class="primary">Nueva</button> <button id="installApp" class="primary" style="display:none">Instalar</button>
      <button id="theme" class="iconbtn" aria-label="Cambiar tema">ðŸŒž</button>
    </div>
  </header>

  <div class="container">
    <div class="stats">
      <div><div class="mini">Tiempo</div><strong id="time" class="tabnums">00:00</strong></div>
      <div class="row">
        <button id="pencil" class="ghost">Notas</button>
        <button id="check" class="warn">Comprobar</button>
        <button id="hint" class="good">Pista</button>
      </div>
    </div>

    <div class="grid-wrap">
      <div id="grid" class="grid" aria-label="Tablero de sudoku"></div>
    </div>

    <div class="pad" id="numpad"></div>
    <div class="counter" id="counter"></div>
  </div>

  <div class="win" id="win">
    <div class="confetti" id="confetti"></div>
    <div class="card">
      <h2>ðŸŽ‰ Â¡Completado!</h2>
      <div class="mini">Tiempo: <b id="winTime">00:00</b></div>
      <div style="height:10px"></div>
      <button id="playAgain" class="primary">Jugar de nuevo</button>
    </div>
  </div>

  <footer>Separadores 3Ã—3 exactos (entre 3/4 y 6/7) â€¢ LÃ­neas internas suaves â€¢ Celdas cuadradas.</footer>

















<script>
// ===== VeruchiDoku â€” Persistencia con puzzle base (no depende de newGame) =====
(function(){
  const SAVE_KEY = 'veruchidoku-save-v3';
  const DEF_LEVEL = 'media';
  let booting = true, queuedNewGameArgs = null, _newGame = null;

  const clone9 = (m) => (m||[]).map(r => (r||[]).slice());

  function capturePuzzleBase(){
    const base = Array(9).fill(null).map(()=>Array(9).fill(0));
    for (let r=0;r<9;r++) for (let c=0;c<9;c++){
      const v = (window.board && window.board[r] && window.board[r][c]) || 0;
      if (v) base[r][c] = v;
    }
    return base;
  }

  function extractMoves(current, base){
    const moves = [];
    for (let r=0;r<9;r++) for (let c=0;c<9;c++){
      const v = (current && current[r] && current[r][c]) || 0;
      if (base[r][c] === 0 && v) moves.push([r,c,v]);
    }
    return moves;
  }

  function extractNotes(notes, base){
    if (!notes) return null;
    const out = [];
    for (let r=0;r<9;r++) for (let c=0;c<9;c++){
      if (base[r][c] === 0) {
        const n = notes[r] && notes[r][c];
        if (n && n.length) out.push([r,c,[...n]]);
      }
    }
    return out.length ? out : null;
  }

  function applyPuzzleBase(base){
    window.board = clone9(base);
  }

  function applyMoves(moves, base){
    if (!Array.isArray(moves)) return;
    for (const [r,c,v] of moves){
      if (base[r][c] === 0 && window.board && window.board[r]) window.board[r][c] = v;
    }
  }

  function applyNotes(notesArr, base){
    if (!Array.isArray(notesArr)) return;
    if (!window.notes) return;
    for (const [r,c,vals] of notesArr){
      if (base[r][c] === 0 && window.notes[r]) window.notes[r][c] = Array.isArray(vals) ? vals.slice(0) : [];
    }
  }

  function saveAll(){
    try{
      if (!window.board) return;
      const base = capturePuzzleBase();
      const payload = {
        puzzleBase: base,
        moves: extractMoves(window.board, base),
        notes: extractNotes(window.notes, base),
        pencil: !!window.pencil,
        elapsed: (typeof window.seconds !== 'undefined') ? window.seconds : 0
      };
      localStorage.setItem(SAVE_KEY, JSON.stringify(payload));
    }catch(err){ console.warn('[VDK] saveAll error:', err); }
  }

  function restoreAll(){
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return false;
    try{
      const data = JSON.parse(raw);
      if (!data || !data.puzzleBase) return false;
      applyPuzzleBase(data.puzzleBase);
      applyMoves(data.moves, data.puzzleBase);
      applyNotes(data.notes, data.puzzleBase);
      if (typeof window.seconds !== 'undefined') window.seconds = data.elapsed || 0;
      window.pencil = !!data.pencil;
      if (typeof window.render === 'function') window.render();
      if (typeof window.renderPad === 'function') window.renderPad();
      return true;
    }catch(err){ console.warn('[VDK] restoreAll error:', err); return false; }
  }

  function wrapNewGameOnce(){
    if (typeof window.newGame !== 'function' || _newGame) return;
    _newGame = window.newGame;
    window.newGame = function(...args){
      if (booting) { queuedNewGameArgs = args.length ? args : null; return; }
      const r = _newGame.apply(this, args);
      setTimeout(saveAll, 0);
      return r;
    };
  }

  function hookSaves(){
    if (typeof window.inputNumber === 'function'){
      const orig = window.inputNumber;
      window.inputNumber = function(n){
        const r = orig.apply(this, arguments);
        if ('requestIdleCallback' in window) requestIdleCallback(saveAll, {timeout:500});
        else setTimeout(saveAll, 150);
        return r;
      };
    }
  }

  window.addEventListener('load', () => {
    wrapNewGameOnce();
    let restored = false;
    try {
      if (window.board) {
        restored = restoreAll();
        if (!restored && _newGame && !queuedNewGameArgs) queuedNewGameArgs = [DEF_LEVEL];
      }
    } catch (_) {}
    booting = false;
    if (!restored && _newGame) {
      _newGame.apply(window, queuedNewGameArgs || [DEF_LEVEL]);
      setTimeout(saveAll, 0);
    }
    hookSaves();
  });

  window.clearSavedGame = function(){ localStorage.removeItem(SAVE_KEY); };
})();
</script>

</body>
</html>
